<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Photobooth ITB 2026</title>
<!-- <script src="script.js"></script> -->

<style>
body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(180deg,#e6f7f3,#cdeee6);
  font-family:system-ui,Arial,sans-serif;
}
.app{text-align:center}
.controls{margin-bottom:12px}
button,select{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  background:#2b7a78;
  color:#fff;
  font-size:14px;
  cursor:pointer;
}
button:disabled{opacity:.5}

.frame{
  position:relative;
  width:360px;
  aspect-ratio:540/1620;
  background:url("frame.png") no-repeat center/contain;
}

/* SLOT FOTO */
.slot{
  position:absolute;
  left:6%;
  width:88%;
  height:18.9%;
  overflow:hidden;
  border-radius:18px;
}
#slot1{top:22.3%}
#slot2{top:49.3%}
#slot3{top:76.3%}

video,canvas{
  width:100%;
  height:100%;
  object-fit:cover;
}
canvas{display:none}

.count{
  position:absolute;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:56px;
  color:white;
  text-shadow:0 0 20px black;
  pointer-events:none;
}
</style>
</head>

<body>
<div class="app">

  <div class="controls">
    <select id="delay">
      <option value="3000">3 detik</option>
      <option value="4000">4 detik</option>
      <option value="5000">5 detik</option>
    </select>
    <button id="start">START</button>
    <button id="download" disabled>DOWNLOAD</button>
    <button id="reset">RESET</button>
  </div>

  <div class="frame" id="frame">
    <div class="slot" id="slot1">
      <video autoplay muted playsinline></video>
      <canvas></canvas>
      <div class="count"></div>
    </div>
    <div class="slot" id="slot2">
      <video autoplay muted playsinline></video>
      <canvas></canvas>
      <div class="count"></div>
    </div>
    <div class="slot" id="slot3">
      <video autoplay muted playsinline></video>
      <canvas></canvas>
      <div class="count"></div>
    </div>
  </div>

</div>

<audio id="shutter" src="shutter.mp3"></audio>

<script>
const slots = document.querySelectorAll(".slot");
const startBtn = document.getElementById("start");
const downloadBtn = document.getElementById("download");
const resetBtn = document.getElementById("reset");
const delaySel = document.getElementById("delay");
const shutter = document.getElementById("shutter");

let stream;

/* CAMERA */
async function startCamera(){
  if(stream) return;
  stream = await navigator.mediaDevices.getUserMedia({ video:true });

  slots.forEach(s=>{
    const v = s.querySelector("video");
    v.srcObject = stream;
  });

  // tunggu kamera benar-benar siap
  await new Promise(r=>setTimeout(r,500));
}

/* COUNTDOWN */
function countdown(el){
  return new Promise(res=>{
    let c = 3;
    el.textContent = c;
    const i = setInterval(()=>{
      c--;
      if(c === 0){
        clearInterval(i);
        el.textContent = "";
        res();
      }else{
        el.textContent = c;
      }
    },1000);
  });
}

/* CAPTURE */
function takePhoto(slot){
  const v = slot.querySelector("video");
  const c = slot.querySelector("canvas");

  if(v.videoWidth === 0) return;

  c.width = v.videoWidth;
  c.height = v.videoHeight;
  c.getContext("2d").drawImage(v,0,0,c.width,c.height);

  c.style.display="block";
  v.style.display="none";

  shutter.currentTime = 0;
  shutter.play();
}

/* START */
startBtn.onclick = async ()=>{
  startBtn.disabled=true;
  await startCamera();

  for(const slot of slots){
    await countdown(slot.querySelector(".count"));
    takePhoto(slot);
    await new Promise(r=>setTimeout(r,delaySel.value));
  }

  downloadBtn.disabled=false;
};

/* RESET */
resetBtn.onclick = ()=>{
  slots.forEach(s=>{
    s.querySelector("canvas").style.display="none";
    s.querySelector("video").style.display="block";
  });
  startBtn.disabled=false;
  downloadBtn.disabled=true;
};

/* ===== DOWNLOAD FIX FINAL (AMAN SEMUA BROWSER) ===== */
downloadBtn.onclick = ()=>{
  const img = new Image();
  img.crossOrigin = "anonymous"; // ðŸ”¥ WAJIB
  img.src = "frame.png";

  img.onload = ()=>{
    const out = document.createElement("canvas");
    out.width = img.naturalWidth;
    out.height = img.naturalHeight;
    const ctx = out.getContext("2d");

    ctx.drawImage(img,0,0);

    const boxes = [
      [0.06,0.223,0.88,0.189],
      [0.06,0.493,0.88,0.189],
      [0.06,0.763,0.88,0.189]
    ];

    slots.forEach((s,i)=>{
      const c = s.querySelector("canvas");
      if(!c.width) return;
      const [x,y,w,h] = boxes[i];
      ctx.drawImage(
        c,
        x*out.width,
        y*out.height,
        w*out.width,
        h*out.height
      );
    });

    out.toBlob(blob=>{
      if(!blob) return;

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "photobooth_ITB2026.png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      // revoke JANGAN langsung
      setTimeout(()=>URL.revokeObjectURL(url),3000);

      // Safari / iOS fallback
      if(/iPhone|iPad/i.test(navigator.userAgent)){
        window.open(url,"_blank");
      }
    },"image/png");
  };
};
</script>

</body>
</html>
